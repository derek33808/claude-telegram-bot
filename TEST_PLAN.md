# Claude Telegram Bot - 测试计划

**版本**: 1.0
**日期**: 2026-01-31
**目标**: 验证 Bot 功能完整性，确保可正式上线

---

## 1. 单元测试用例

### 1.1 安全模块 (security.ts)

| ID | 测试项 | 输入 | 预期结果 |
|----|--------|------|----------|
| SEC-01 | 简单 rm 命令 | `rm /allowed/path/file.txt` | ✅ 通过 |
| SEC-02 | rm 命令 - 禁止路径 | `rm /etc/passwd` | ❌ 拒绝 |
| SEC-03 | rm 命令 - 引号路径 | `rm "/path/with spaces/file"` | ✅ 正确解析 |
| SEC-04 | rm 命令 - 命令注入 | `rm $(cat /etc/passwd)` | ❌ 拒绝 |
| SEC-05 | rm 命令 - 反引号注入 | ``rm `whoami`/file`` | ❌ 拒绝 |
| SEC-06 | rm 命令 - 管道 | `rm file.txt | cat /etc/passwd` | ❌ 拒绝 |
| SEC-07 | 路径验证 - 允许路径 | `~/Documents/test.txt` | ✅ 通过 |
| SEC-08 | 路径验证 - 临时目录 | `/tmp/bot/file.txt` | ✅ 通过 |
| SEC-09 | 路径验证 - 系统目录 | `/usr/bin/bash` | ❌ 拒绝 |
| SEC-10 | 速率限制 | 连续 100 次请求 | 触发限制 |

### 1.2 数据库模块 (db/store.ts)

| ID | 测试项 | 预期结果 |
|----|--------|----------|
| DB-01 | 创建会话 | 成功插入记录 |
| DB-02 | 获取消息 (带 limit) | 返回指定数量消息 |
| DB-03 | 获取消息 (无 limit) | 返回全部消息 |
| DB-04 | 并发锁获取 | 第二次获取失败 |
| DB-05 | 锁过期自动释放 | 过期后可重新获取 |
| DB-06 | 外键约束 | 用户不存在时拒绝创建会话 |

### 1.3 Tmux 解析器 (tmux/parser.ts)

| ID | 测试项 | 输入 | 预期结果 |
|----|--------|------|----------|
| TMX-01 | 检测思考状态 | `✽ thinking...` | isThinking = true |
| TMX-02 | 检测响应文本 | `⏺ Hello, world!` | 正确提取文本 |
| TMX-03 | 检测工具调用 | `⏺ Read(file.txt)` | isToolCall = true |
| TMX-04 | 检测完成状态 | 空 prompt 行 | isComplete = true |
| TMX-05 | promptDetectedAt=0 时 | reset 后立即检查 | isComplete = false |

---

## 2. 集成测试用例

### 2.1 消息处理流程

| ID | 测试项 | 步骤 | 预期结果 |
|----|--------|------|----------|
| INT-01 | 文字消息 | 发送 "hello" | 收到 Claude 响应 |
| INT-02 | 未授权用户 | 非白名单用户发消息 | 返回 "Unauthorized" |
| INT-03 | 速率限制 | 快速发送 20 条 | 触发限制提示 |
| INT-04 | 会话保持 | 发送多条相关消息 | 上下文连续 |

### 2.2 命令处理

| ID | 命令 | 预期结果 |
|----|------|----------|
| CMD-01 | `/start` | 显示欢迎信息 |
| CMD-02 | `/help` | 显示命令列表 |
| CMD-03 | `/new` | 清除当前会话 |
| CMD-04 | `/stop` | 停止当前响应 |
| CMD-05 | `/status` | 显示状态信息 |
| CMD-06 | `/sessions` | 显示可用会话列表 |
| CMD-07 | `/health` | 显示健康状态 |
| CMD-08 | `/history` | 显示消息历史 |

### 2.3 Tmux Bridge 模式

| ID | 测试项 | 预期结果 |
|----|--------|----------|
| TMB-01 | 创建 tmux 会话 | 成功创建 `claude-tg-*` |
| TMB-02 | 发送消息获取响应 | 正确返回 Claude 输出 |
| TMB-03 | 多轮对话 | 上下文保持 |
| TMB-04 | /sessions 接管 | 成功接管 CLI 会话 |
| TMB-05 | /stop 中断 | 发送 Ctrl+C 停止 |
| TMB-06 | CLI 活动监听 | Telegram 显示 CLI 操作 |

---

## 3. 端到端测试用例 (E2E)

### 3.1 基础功能

| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| E2E-01 | Bot 启动 | `bun run start` | 正常启动，显示 Bot 信息 |
| E2E-02 | 简单问答 | 发送 "5+5=?" | 返回 "10" |
| E2E-03 | 代码生成 | 要求生成代码 | 返回格式化代码 |
| E2E-04 | 工具调用 | 要求读取文件 | 显示工具状态 + 结果 |
| E2E-05 | 网络断开恢复 | 模拟网络中断 | 自动重连 |

### 3.2 Tmux 模式完整流程

| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| E2E-T01 | Tmux 会话创建 | 发送消息 | 创建 tmux 会话 |
| E2E-T02 | 响应流式显示 | 长响应 | 实时更新消息 |
| E2E-T03 | 终端同步 | `tmux attach` | 看到相同内容 |
| E2E-T04 | 接管 CLI 会话 | `/sessions` 选择 | 成功接管 |
| E2E-T05 | 切回 CLI | 完成后退出 | CLI 继续运行 |

### 3.3 边界情况

| ID | 场景 | 预期结果 |
|----|------|----------|
| E2E-B01 | 超长消息 | 正确分段发送 |
| E2E-B02 | 特殊字符 | 正确转义显示 |
| E2E-B03 | 空消息 | 忽略或提示 |
| E2E-B04 | 并发请求 | 队列处理，不丢失 |
| E2E-B05 | Bot 重启 | 会话可恢复 |

---

## 4. 安全测试

| ID | 测试项 | 方法 | 预期结果 |
|----|--------|------|----------|
| SEC-E01 | 未授权访问 | 非白名单用户 | 拒绝所有操作 |
| SEC-E02 | 命令注入 | 发送 `; rm -rf /` | 被安全过滤 |
| SEC-E03 | 路径遍历 | `../../etc/passwd` | 拒绝访问 |
| SEC-E04 | 大文件上传 | 上传 100MB 文件 | 拒绝或限制 |
| SEC-E05 | SQL 注入 | 特殊字符会话名 | 正确转义 |

---

## 5. 性能测试

| ID | 测试项 | 指标 | 目标 |
|----|--------|------|------|
| PERF-01 | 响应延迟 | 首字节时间 | < 2s |
| PERF-02 | 内存占用 | 稳定运行 1h | < 200MB |
| PERF-03 | CPU 占用 | 空闲时 | < 5% |
| PERF-04 | 并发处理 | 10 条消息 | 全部处理 |

---

## 6. 测试执行检查清单

### 启动前检查
- [ ] `.env` 配置正确
- [ ] tmux 已安装
- [ ] Claude Code CLI 已登录
- [ ] Telegram Bot Token 有效

### 基础测试
- [ ] E2E-01: Bot 启动
- [ ] E2E-02: 简单问答
- [ ] CMD-01~08: 所有命令

### Tmux 测试
- [ ] E2E-T01~T05: Tmux 完整流程

### 安全测试
- [ ] SEC-E01~E05: 安全边界

---

## 7. 上线检查清单

### 代码质量
- [x] TypeScript 类型检查通过
- [x] P1 问题已修复
- [ ] P2 问题已评估

### 文档
- [x] DESIGN.md 完整
- [x] PROGRESS.md 更新
- [ ] QA_REPORT.md 更新

### 部署
- [ ] LaunchAgent 配置
- [ ] 日志监控设置
- [ ] 错误告警配置
